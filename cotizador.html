<html>

<head>
    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="https://redsisdesarrollo.crm2.dynamics.com//WebResources/new_js_cargar_archivo_cotizacion"
        type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/xlsx@0.14.1/dist/xlsx.full.min.js"></script>

</head>

<body id="bdy" style="overflow-wrap: break-word;" onfocusout="parent.setEmailRange();">
    <br>
    <div id="navbar"><span>Leer Excel </span></div>
    <div id="wrapper">
        <input type="file" id="input-excel">
    </div>
    <script>

        var i;
        var count;
        var contadora;
        var res;
        $('#input-excel').change(function (e) {
            var queryString = window.parent.location.search;
            var urlParams = new URLSearchParams(queryString);
            var reader = new FileReader();
            var productid;

            reader.readAsArrayBuffer(e.target.files[0]);
            reader.onload = function (e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var result = XLSX.utils.sheet_to_json(workbook.Sheets["Tabla de costos"], { header: "A" });

                //console.log(result);

                result.forEach((value, index, array) => {
                    //console.log(value);
                    // console.log(index);
                    //if (value["B"]) console.log(value["B"]);


                    if (!value["A"] && value["B"]) {


                        //console.log("entro en el if");
                        //console.log(value["B"]);
                        //console.log(console.log(value));
                        //console.log(value["E"], value["D"]);
                        //console.log(urlParams.get("id"));

                        let referencia = value["B"];
                        let cantidad = value["D"];
                        let precio = value["E"];
                        webApi(referencia, precio, cantidad, urlParams.get("id"));
                    }


                });




                //var referencia = result[3]["B"];
                //var precio_lista_unitario = result[3]["E"];
                //var cantidad = result[3]["D"];

                //console.log("probando0");
                //console.log(`${referencia}`);
            }
        });

        async function webApi(referencia, precio, cant, url) {

            console.log("inicio funcion api____________________");
            console.log(referencia);
            console.log(precio);
            console.log(cant);
            console.log("fin parametros________________________");
            //precio_lista_unitario = precio;
            //cantidad = cant;
            Xrm.WebApi
                .retrieveMultipleRecords(
                    "product",
                    "?$select=productid&$filter=productnumber eq  '" + referencia + "' "
                )
                .then(
                    async function success(result1) {

                        console.log("entro " + i++);
                        console.log(result1);
                        if (result1.entities[0].productid) {

                            let productid = await result1.entities[0].productid;
                            console.log(productid);

                            // var data = await {
                            //     "productid@odata.bind": "/products(" + productid + ")",
                            //     "priceperunit": Number(precio),
                            //     "quantity": Number(cant),
                            //     "quoteid@odata.bind": "/quotes(" + url + ")",
                            //     "uomid@odata.bind": "/uoms(f6008f58-2cf0-ea11-a815-000d3ac090ba)"
                            // }

                            var data =
                                await {
                                    "productid": productid,
                                    "creditonhold": false,
                                    "address1_latitude": 47.639583,
                                    "description": "This is the description of the sample account",
                                    "revenue": 5000000,
                                    "accountcategorycode": 1
                                }
                            console.log(data);
                            // create  record
                            Xrm.WebApi.createRecord("quotedetail", data).then(
                                function success(result2) {
                                    console.log("hola");
                                    console.log("QuoteDetail created with ID: " + result2.id);
                                },
                                function (error) {
                                    console.log(error.message);
                                }
                            );



                            cerrar();
                        }


                    },
                    function (error) {
                        console.log(error.message);
                        // handle error conditions
                    }
                );


        }
    </script>

</body>

</html>